#include "sensor.h"



/* Buttons--------------------------------------------------------*/

#define DEBOUNCE_DELAY 50 // Debounce delay time 50ms

bool debounce_flag = false;
uint32_t last_debounce_time = 0;


// Main loop or timer interrupt service routine
void CheckButtonState(void)
{
    uint32_t current_time = HAL_GetTick();
    // Check whether the bounce time has been reached
    if(debounce_flag && (current_time - last_debounce_time) >= DEBOUNCE_DELAY) {
        // Read button pin state
        if(HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13) == GPIO_PIN_RESET) {
            ms_motor_control(&motor_shield_v1, MS_V1, M1, 0);
        }
        debounce_flag = false; // Reset debounce flag
    }
}


/* HC-SR04--------------------------------------------------------*/

volatile uint32_t echo_start_time = 0;
volatile uint32_t echo_end_time = 0;
volatile uint8_t echo_received = 0;


// 發送超聲波脈衝
void hc_sr04_trig(GPIO_TypeDef* port, uint16_t pin)
{
    HAL_GPIO_WritePin(port, pin, GPIO_PIN_RESET);
    //delay_us(2);
    HAL_Delay(2); // 等待 2ms 確保清除
    HAL_GPIO_WritePin(port, pin, GPIO_PIN_SET);
    //delay_us(10);
    HAL_Delay(10); // 發送 10us 的脈衝
    HAL_GPIO_WritePin(port, pin, GPIO_PIN_RESET);
}


// 計算距離
float hc_sr04_distance(void)
{
	float distance = 0;
	
    if (echo_received) {
        uint32_t duration = echo_end_time - echo_start_time;
        distance = duration * .0343 / 2; // 計算距離（單位：cm）
        echo_received = 0; // 重置標誌
    }
	
	return distance;
}




// Interrupt Service Routine
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    if(GPIO_Pin == GPIO_PIN_13) {
        uint32_t current_time = HAL_GetTick();
        if(!debounce_flag) {
            last_debounce_time = current_time;
            debounce_flag = true;
        }
    }

    if (GPIO_Pin == GPIO_PIN_9) {
        if (HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_9) == GPIO_PIN_SET) {
            echo_start_time = HAL_GetTick(); // 記錄開始時間
        } else {
            echo_end_time = HAL_GetTick(); // 記錄結束時間
            echo_received = 1; // 設置已接收標誌
        }
    }

}