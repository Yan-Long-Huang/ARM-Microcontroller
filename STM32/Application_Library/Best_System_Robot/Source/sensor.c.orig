#include "sensor.h"

/* Buttons--------------------------------------------------------*/

// 定義按鈕陣列
Button_TypeDef button[NUM_BUTTONS] = {
    {GPIOC, GPIO_PIN_0 , true , false, 0, Button1_Pressed}, // SW_Middle_Up,      上拉觸發
    {GPIOC, GPIO_PIN_1 , true , false, 0, Button2_Pressed}, // SW_Middle_Down,    上拉觸發
    {GPIOC, GPIO_PIN_2 , true , false, 0, Button3_Pressed}, // SW_Left,           上拉觸發
    {GPIOC, GPIO_PIN_3 , true , false, 0, Button4_Pressed}, // SW_Right,          上拉觸發
    {GPIOA, GPIO_PIN_15, true , false, 0, Button5_Pressed}, // SW_Revolver_Left,  上拉觸發
    {GPIOB, GPIO_PIN_7 , true , false, 0, Button6_Pressed}, // SW_Revolver_Right, 上拉觸發
    {GPIOC, GPIO_PIN_13, false, false, 0, Button7_Pressed}  // SW_Middle_Bracket, 下拉觸發
};


// 檢查按鈕狀態
void Button_CheckState(Button_TypeDef* button)
{
    uint32_t current_time = HAL_GetTick();

    if(button->debounce_flag && (current_time - button->last_debounce_time) >= DEBOUNCE_DELAY) {
        GPIO_PinState pin_state = HAL_GPIO_ReadPin(button->port, button->pin);
        if((button->is_pull_up && pin_state == GPIO_PIN_SET) || (!button->is_pull_up && pin_state == GPIO_PIN_RESET)) {
            button->callback();
        }
        button->debounce_flag = false; // 重置防彈跳標誌
    }
}

bool Button_IsPressed(Button_TypeDef* button)
{
    GPIO_PinState pin_state = HAL_GPIO_ReadPin(button->port, button->pin);
    return (button->is_pull_up && pin_state == GPIO_PIN_SET) || (!button->is_pull_up && pin_state == GPIO_PIN_RESET);
}


// 按鈕中斷處理函數
void Button_HandleInterrupt(uint16_t GPIO_Pin, Button_TypeDef* buttons, int num_buttons)
{
    for(int i = 0; i < num_buttons; i++) {
        if(GPIO_Pin == buttons[i].pin) {
            uint32_t current_time = HAL_GetTick();
            if(!buttons[i].debounce_flag) {
                buttons[i].last_debounce_time = current_time;
                buttons[i].debounce_flag = true;
            }
        }
    }
}


// 按鈕按下回調函數的實現
void Button1_Pressed(void) // SW_Middle_Up
{
    ms_motor_control(&motor_shield_v1, MS_V1, M1, 0);
}

void Button2_Pressed(void) // SW_Middle_Down
{
    ms_motor_control(&motor_shield_v1, MS_V1, M1, 0);
}

void Button3_Pressed(void) // SW_Left
{
    ms_motor_control(&motor_shield_v1, MS_V1, M3, 0);
}

void Button4_Pressed(void) // SW_Right
{
    ms_motor_control(&motor_shield_v1, MS_V1, M4, 0);
}

void Button5_Pressed(void) // SW_Revolver_Left
{

}

void Button6_Pressed(void) // SW_Revolver_Right
{

}

void Button7_Pressed(void) // SW_Middle_Bracket
{
    // 執行按鈕按下時的動作
}



// Interrupt Service Routine
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    // Handle button interrupt
    Button_HandleInterrupt(GPIO_Pin, button, NUM_BUTTONS);

    // Check if the echo_pin of any HC-SR04 sensor triggered the interrupt
    HC_SR04_HandleInterrupt(GPIO_Pin, hc_sr04, 3);
}

